//TODO handle ws dependency
var s = module.exports = {
	listeners:{},
	sub: (ws,channel)=>{
    	if(!s.listeners[channel]){
    		s.listeners[channel] = [];
    	}
    	s.listeners[channel].push(ws);
    	s.broadcast(channel,ws.username + " joined");
	},
	broadcast:(channel,message)=>{
		console.log("#"+channel+"> "+message);
		if(s.listeners[channel]){
			s.listeners[channel].forEach((ws)=>{
				ws.send(JSON.stringify({
					channel,
					message
				}));
			});
		}
	},
	unsub:(ws,channel)=>{
		if(channel){
			//console.log("Unsubbing from #" + channel);
			if(s.listeners[channel]){
				var i = s.listeners[channel].indexOf(ws);
				if(i>=0){
					s.listeners[channel].splice(i,1);
					s.broadcast(channel,ws.username + " left");
				}
				//TODO remove channel if empty

			}
		}else{
			//console.log("Unsubbing from all channels");
			for(var channel in s.listeners){
				var i = s.listeners[channel].indexOf(ws);
				if(i>=0){
					s.listeners[channel].splice(i,1);
					s.broadcast(channel,ws.username + " left");
				}
				//TODO remove channel if empty
			}
		}
	}
};